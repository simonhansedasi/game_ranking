<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYT Game Ranker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        input, button {
            padding: 10px;
            margin: 10px;
            font-size: 16px;
        }
        .score {
            font-size: 20px;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <h1>NYT Game Ranker</h1>
    
    <h2>Today's Connections Puzzle Scoring</h2>
    <div id="currentConnectionsRank"></div>

    <div class="score" id="connectionsScore"></div>

    <textarea id="connectionsString" rows="12" cols="15" placeholder="Enter the connections puzzle string here..."></textarea>
    <button onclick="submitScore('connections')">Submit Score</button>
    <br>
    <img id="plotConnectionsImage" src="" alt="Recent Connections Scores Plot" />


    
    
    
    
    <h2>Today's Strands Puzzle Scoring</h2>
    <div id="currentStrandsRank"></div>

    <div class="score" id="strandsScore"></div>

    <ul id="rankings"></ul>
    <textarea id="strandsString" rows="12" cols="15" placeholder="Enter the strands puzzle string here..."></textarea>
    <button onclick="submitScore('strands')">Submit Score</button>
    <br>
    <img id="plotStrandsImage" src="" alt="Recent Strands Scores Plot" />

    
    
    

    
    
    
<script>
    
    // Helper function to set a cookie
function setCookie(name, value, days) {
    const date = new Date();
    date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000); // Set expiration in milliseconds
    const expires = `expires=${date.toUTCString()}`;
    document.cookie = `${name}=${value}; ${expires}; path=/; Secure`;
}
// Helper function to get a cookie by name
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}



// Ensure a session ID exists, creating it only if necessary
function ensureSessionID() {
    const existingSessionID = getCookie('session_id');

    if (!existingSessionID) {
        // Fetch a new session ID only if it doesn't exist
        fetch('https://550fb17db6d8.ngrok.app/get_session_id', {
            method: 'GET',
            credentials: 'include', // Include cookies for session management
        })
            .then(response => response.json())
            .then(data => {
                setCookie('session_id', data.session_id, 30); // Persist for 30 days
                console.log('Session ID created and saved:', data.session_id);
            })
            .catch(error => console.error('Error fetching session ID:', error));
    } else {
        console.log('Session ID already exists:', existingSessionID);
    }
}

// Ensure session ID on page load
ensureSessionID();

    
    

    
// Function to fetch and display the current ranking
function fetchAndDisplayRank(gameType) {
    const rankElementId = gameType === 'connections' ? 'currentConnectionsRank' : 'currentStrandsRank';

    fetch(`https://550fb17db6d8.ngrok.app/get_ranking?game_type=${gameType}`, {
        method: 'GET',
        credentials: 'include',
    })
        .then(response => response.json())
        .then(data => {
            if (data.rank) {
                document.getElementById(rankElementId).innerHTML = `Current rank: ${data.rank}`;
            } else {
                document.getElementById(rankElementId).innerHTML = 'Puzzle not yet ranked';
            }
        })
        .catch(error => {
            console.error(`Error fetching ${gameType} ranking:`, error);
            document.getElementById(rankElementId).innerHTML = 'Error fetching ranking.';
        });
}
    
function updateImage() {
    // Assuming the plot is already generated at /static/recent_scores.png
    const imageStrandsUrl = 'https://550fb17db6d8.ngrok.app/static/images/Strands_recent_scores.png';
    const imageConnectionssUrl = 'https://550fb17db6d8.ngrok.app/static/images/Connections_recent_scores.png';

    // Update the image source dynamically
    document.getElementById('plotStrandsImage').src = imageStrandsUrl;
    document.getElementById('plotConnectionsImage').src = imageConnectionssUrl;
}
    
    
    
    
    
// Function to submit the score
function submitScore(gameType) {
    let puzzleString = '';
    let scoreElementId = '';
    let rankElementId = '';

    if (gameType === 'connections') {
        puzzleString = document.getElementById("connectionsString").value;
        scoreElementId = "connectionsScore";
        rankElementId = "currentConnectionsRank";

    } else if (gameType === 'strands') {
        puzzleString = document.getElementById("strandsString").value;
        scoreElementId = "strandsScore";
        rankElementId = "currentStrandsRank";

    }

    const session_id = getCookie('session_id'); // Retrieve session ID from cookies

    // Send the puzzle string to the appropriate endpoint
    fetch(`https://550fb17db6d8.ngrok.app/score_game`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            game_string: gameType, // Pass game type to identify the game
            puzzle_string: puzzleString,
            session_id: session_id, // Send the persistent session ID
        }),
        credentials: 'include',
    })
        .then(response => response.json())
        .then(data => {
            document.getElementById(scoreElementId).innerHTML = `Your score: ${data.score}`;
                // Fetch and update the rank after submitting the score
        fetchAndDisplayRank(gameType); // This will refresh the rank message
        })
        .catch(error => {
            document.getElementById(scoreElementId).textContent = `Error: ${error.message}`;
            console.error('Error:', error);
        })
    
    updateImage();
    
}
    window.onload = function () {
    fetchAndDisplayRank('connections');
    fetchAndDisplayRank('strands');
    updateImage;
};

</script>
    


</body>
</html>
